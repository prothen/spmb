<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>SPMB: SPMB</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SPMB
   </div>
   <div id="projectbrief">Firmware of the Signal&amp;Power Management Board for Atmega328p based devices.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title"><a class="el" href="namespaceSPMB.html" title="Namespace collecting all SPMB classes and utilities used in firmware.ino. ">SPMB</a> </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Brief</h2>
<p>The Signal&amp;Power Management Board (<b><a class="el" href="namespaceSPMB.html" title="Namespace collecting all SPMB classes and utilities used in firmware.ino. ">SPMB</a></b>) provides firmware for Arduino UNO devices using Atmega328p microcontrollers facilitating a Robot Operating System (<b>ROS</b>) interface for a radio controlled (<b>RC</b>) supervised vehicle. Here the current configuration is based on the <b>TRAXXAS</b> platforms (in specific TRX4). The <a class="el" href="namespaceSPMB.html" title="Namespace collecting all SPMB classes and utilities used in firmware.ino. ">SPMB</a> provides direct RC forwarding and publishing of actuated control signals to the ROS interface. With a predefined fast switching sequence of channels the software based control algorithms are activated. Furthermore a failsafe for idled software connections is embedded such that RC operation is activated if less than <em>10Hz</em> control frequency is present. If a RC channel is not read successfully, e.g. broken wires or empty batteries, the channel is deactivated and the output goes in the channels default control signal. In case of velocity and steering this corresponds to 0 actuation. In addition lowpass filtering of all control signals, both remote and software based is included and can be customised by adapting the parameters under <code><a class="el" href="setup__macros_8h_source.html">firmware/setup_macros.h</a></code>. The main and control loop time is configured and tested at <em>50Hz</em>. Theoretically much higher frequencies are possible, however interrupt reading capability greatly deteriorates with a fast main loop frequency. Therefore it is recommended to not vary these frequencies to higher values or otherwise stable performance can not be guaranteed. Also the firmware provides a led signaling class which provides easily accessible information about the current <a class="el" href="namespaceSPMB.html" title="Namespace collecting all SPMB classes and utilities used in firmware.ino. ">SPMB</a>'s state machine status.</p>
<ul>
<li><b>Main loop</b> in <a class="el" href="firmware_8ino_source.html">firmware.ino</a> depending on<ul>
<li><b>StatusIndicator</b><ul>
<li><a class="el" href="si_8h_source.html">si.h</a> - LED signaling and exposing information to environment</li>
</ul>
</li>
<li><b>InterruptManager</b><ul>
<li><a class="el" href="input__rc_8h_source.html">input_rc.h</a> - Input via RC</li>
</ul>
</li>
<li><b>ROSInterface</b><ul>
<li><a class="el" href="ros__interface_8h_source.html">ros_interface.h</a> - Input via ROS and publish actuated control</li>
</ul>
</li>
<li><b>LowPass</b><ul>
<li><a class="el" href="lowpass_8h_source.html">lowpass.h</a> - Filter for output elements</li>
</ul>
</li>
<li><b>OutputDriverI2C</b><ul>
<li><a class="el" href="output__i2c_8h_source.html">output_i2c.h</a> - Output via I2C to timer PCB</li>
</ul>
</li>
<li><b>SetupSPMB</b><ul>
<li><a class="el" href="setup_8h_source.html">setup.h</a> - Initial pin configurations and setup of objects</li>
</ul>
</li>
<li><b>StateMachine</b><ul>
<li><a class="el" href="sm_8h_source.html">sm.h</a> - Execute main logic loop and interface with all involved elements</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr/>
<h2>Features</h2>
<ul>
<li>RC Forwarding</li>
<li>Safety logic for both ROS- and RC-based control</li>
<li>Actuation output via ROS for debugging and learning of manual controlled maneuvers or continuation of actuation-based estimator while supervised intervention</li>
<li>Switching logic with state machine considering idle conditions, various error cases and providing supervisor interrupt via braking maneuver</li>
<li><em>50 Hz</em> actuation and lowpass filtered control</li>
<li>OOP based modules with independent use cases both with and without ROS usage (serial and ros nodehandle.loginfo debugging possible)</li>
<li>Installation of udev rules for unique device node under <code>/dev/spmb</code></li>
<li>Scripts for installing ros libraries to Arduino library folder <code>~/Arduino/libraries/</code></li>
<li>Doxygen based API as reference as basis for continuoous integration</li>
</ul>
<hr/>
<h2>Execute the ROS Interface</h2>
<ul>
<li>Run <code>roslaunch spmb run.launch</code></li>
</ul>
<p>(<em>If any configuration parameters regarding baudrate have been adjusted then parse the corresponding parameter in the launch file e.g. <code>roslaunch spmb run.launch baud:=yourbaudrateinteger</code></em>)</p>
<ul>
<li>After approximately 3-4 seconds the terminal will output</li>
</ul>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;setting /run_id to 4e4bd514-a7b2-11e9-a7b3-4485007bad36</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;process[rosout-1]: started with pid [25122]</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;started core service [/rosout]</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;process[serial_node-2]: started with pid [25128]</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;[INFO] [1563271988.137866]: ROS Serial Python Node</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;[INFO] [1563271988.149294]: Connecting to /dev/spmb at 57600 baud</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;[ERROR] [1563272005.372626]: Unable to sync with device; possible link problem or link software version mismatch such as hydro rosserial_python with groovy Arduino</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;[INFO] [1563272005.404425]: Note: publish buffer size is 100 bytes</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;[INFO] [1563272005.406264]: Setup publisher on actuated [spmb/actuated]</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;[INFO] [1563272005.418630]: Note: subscribe buffer size is 100 bytes</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;[INFO] [1563272005.419878]: Setup subscriber on request [spmb/request]</div></div><!-- fragment --><p>(<em>Note that initially there will be a single error output regarding a sync problem. After this the publishers should be initialised and no further error messages should be shown.</em>)</p>
<hr/>
<h2>Dependencies</h2>
<h3>Install Arduino Libraries</h3>
<p>Go to <code>cd ~/Arduino/libraries</code></p>
<ul>
<li><code>git clone <a href="https://github.com/adafruit/Adafruit-PWM-Servo-Driver-Library.git">https://github.com/adafruit/Adafruit-PWM-Servo-Driver-Library.git</a></code></li>
<li><code>git clone <a href="https://github.com/maniacbug/StandardCplusplus.git">https://github.com/maniacbug/StandardCplusplus.git</a></code></li>
<li>Download and install Arduino (v1.8.5) (x64 <a href="https://www.arduino.cc/download_handler.php?f=/arduino-1.8.5-linux64.tar.xz">https://www.arduino.cc/download_handler.php?f=/arduino-1.8.5-linux64.tar.xz</a>)</li>
<li>Build the repository to generate header files for messages with <code>catkin build</code> in any directory of your catkin workspace</li>
<li>Source your workspace with <code>source ~/your_workspace/devel/setup.bash</code></li>
<li>Run the <code>make_library.sh</code> script in the root of this repository</li>
<li>If desired install the udev rule file under <code>resources/99-spmb.rules</code>, which will install the permanent device node <code>dev/spmb</code> to avoid the deviating node identifier ttyACMx with x changing based on the amount of ttyACM devices or reconnections of the same device)</li>
</ul>
<h3>Interface with ROS</h3>
<ul>
<li>After installing the udev rules (see below) the ROS Interface can be accessed with <code>rosrun rosserial_python serial_node.py _port:=/dev/spmb _baud:=57600</code></li>
<li>The <code>rosrun</code> command is conveniently embedded into the launch file under <code>launch/run.launch</code> (see <em>Execute the ROS Interface</em> section above)</li>
</ul>
<h3>Install udev-rules</h3>
<ul>
<li>You can find the rules under the folder <code>resources</code> with the name <code>99-spmb.rules</code></li>
<li>Easiest way to identify the device node is to unplug all usb devices from your work station except the Arduino UNO. Then before connecting the Arduino you can list the devices with <code>ls /dev</code> and then after connecting the Arduino entering the command <code>ls /dev</code> should show a new device node entry. (Usually <code>/dev/ttyACMx</code> where x is some number relating to the amount of currently registered ttyACM devices)</li>
<li>Assuming that your Arduino identifies with <code>/dev/ttyACM0</code> you can list the hardware information with the command</li>
</ul>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;udevadm info -ap /sys/class/tty/ttyACM0</div></div><!-- fragment --><ul>
<li>From there extract the serial attribute with</li>
</ul>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;udevadm info -ap /sys/class/tty/ttyACM0 | grep &quot;^    ATTRS{serial}==&quot;</div></div><!-- fragment --><p>which should show something similar to</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;$ udevadm info -ap /sys/class/tty/ttyACM0 | grep &quot;^    ATTRS{serial}==&quot;</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;    ATTRS{serial}==&quot;85430353331351E0D120&quot;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    ATTRS{serial}==&quot;0000:00:14.0&quot;</div></div><!-- fragment --><ul>
<li>Open the file <code>99-spmb.rules</code> under <code>resources/</code> and replace the default entry for serial <code>ATTRS{serial}=="55736313238351219281"</code> with your terminal output e.g. <code>ATTRS{serial}=="85430353331351E0D120"</code></li>
<li>Copy the file into the udev folder using super user privileges</li>
</ul>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;sudo cp resources/99-spmb.rules /etc/udev/rules.d/</div></div><!-- fragment --><ul>
<li>Reload and trigger the rules using</li>
</ul>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;udevadm control --reload-rules &amp;&amp; udevadm trigger</div></div><!-- fragment --><p><em>If <code>ls /dev</code> doesn't show the entry</em> <b>dev/spmb</b> <em>try rebooting your work station and if the entry still doesn't show reiterate throught the instructions to make sure you followed them correctly.</em></p>
<hr/>
<h2>Contribution</h2>
<p>Pull requests from forked repositories and opening new issues are very welcome and much appreciated.</p>
<p>Contributions are invited to adhere to the <a href="https://google.github.io/styleguide/cppguide.html">C++ Google Style Guide</a>.</p>
<p><b>Maintainer:</b> Philipp Rothenhäusler (<em>phirot a t kth.se | philipp.rothenhaeusler a t gmail.com</em>) </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
