<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>SPMB: /home/flip/workspaces/itrl/trx/src/spmb/README.md Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SPMB
   </div>
   <div id="projectbrief">Firmware of the Signal&amp;Power Management Board for Atmega328p based devices.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">/home/flip/workspaces/itrl/trx/src/spmb/README.md</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# SPMB</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;## Brief</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;The Signal&amp;Power Management Board (**SPMB**) provides firmware for Arduino UNO devices using Atmega328p microcontrollers facilitating a Robot Operating System (**ROS**) interface for a radio controlled (**RC**) supervised vehicle. Here the current configuration is based on the **TRAXXAS** platforms (in specific TRX4). The SPMB provides direct RC forwarding and publishing of actuated control signals to the ROS interface.  With a predefined fast switching sequence of channels the software based control algorithms are activated. Furthermore a failsafe for idled software connections is embedded such that RC operation is activated if less than *10Hz* control frequency is present. If a RC channel is not read successfully, e.g. broken wires or empty batteries, the channel is deactivated and the output goes in the channels default control signal. In case of velocity and steering this corresponds to 0 actuation.</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;In addition lowpass filtering of all control signals, both remote and software based is included and can be customised by adapting the parameters under `firmware/setup_macros.h`. The main and control loop time is configured and tested at *50Hz*. Theoretically much higher frequencies are possible, however interrupt reading capability greatly deteriorates with a fast main loop frequency. Therefore it is recommended to not vary these frequencies to higher values or otherwise stable performance can not be guaranteed.</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;Also the firmware provides a led signaling class which provides easily accessible information about the current SPMB&#39;s state machine status.  </div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;- **Main loop** in firmware.ino depending on</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    - **StatusIndicator**       </div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;        + si.h - LED signaling and exposing information to environment</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;    - **InterruptManager**      </div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;        + input_rc.h - Input via RC</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;    - **ROSInterface**          </div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;        + ros_interface.h - Input via ROS and publish actuated control</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;    - **LowPass**               </div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;        + lowpass.h - Filter for output elements</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;    - **OutputDriverI2C** </div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;        + output_i2c.h - Output via I2C to timer PCB</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;    - **SetupSPMB**</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;        + setup.h - Initial pin configurations and setup of objects</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;    - **StateMachine**          </div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;        + sm.h - Execute main logic loop and interface with all involved elements</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;***</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;## Features</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;- RC Forwarding</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;- Safety logic for both ROS- and RC-based control</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;- Actuation output via ROS for debugging and learning of manual controlled maneuvers or continuation of actuation-based estimator while supervised intervention</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;- Switching logic with state machine considering idle conditions, various error cases and providing supervisor interrupt via braking maneuver</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;- *50 Hz* actuation and lowpass filtered control</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;- OOP based modules with independent use cases both with and without ROS usage (serial and ros nodehandle.loginfo debugging possible)</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;- Installation of udev rules for unique device node under `/dev/spmb`</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;- Scripts for installing ros libraries to Arduino library folder `~/Arduino/libraries/`</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;- Doxygen based API as reference as basis for continuoous integration</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;***</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;## Execute the ROS Interface</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;- Run `roslaunch spmb run.launch`</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;(*If any configuration parameters regarding baudrate have been adjusted then parse the corresponding parameter in the launch file e.g. `roslaunch spmb run.launch baud:=yourbaudrateinteger`*)</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;- After approximately 3-4 seconds the terminal will output </div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;```</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;setting /run_id to 4e4bd514-a7b2-11e9-a7b3-4485007bad36</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;process[rosout-1]: started with pid [25122]</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;started core service [/rosout]</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;process[serial_node-2]: started with pid [25128]</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;[INFO] [1563271988.137866]: ROS Serial Python Node</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;[INFO] [1563271988.149294]: Connecting to /dev/spmb at 57600 baud</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;[ERROR] [1563272005.372626]: Unable to sync with device; possible link problem or link software version mismatch such as hydro rosserial_python with groovy Arduino</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;[INFO] [1563272005.404425]: Note: publish buffer size is 100 bytes</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;[INFO] [1563272005.406264]: Setup publisher on actuated [spmb/actuated]</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;[INFO] [1563272005.418630]: Note: subscribe buffer size is 100 bytes</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;[INFO] [1563272005.419878]: Setup subscriber on request [spmb/request]</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;```</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;(*Note that initially there will be a single error output regarding a sync problem. After this the publishers should be initialised and no further error messages should be shown.*)</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;***</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;## Dependencies</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;### Install Arduino Libraries</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;Go to `cd ~/Arduino/libraries`</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;- `git clone https://github.com/adafruit/Adafruit-PWM-Servo-Driver-Library.git`</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;- `git clone https://github.com/maniacbug/StandardCplusplus.git`</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;- Download and install Arduino (v1.8.5) (x64 https://www.arduino.cc/download_handler.php?f=/arduino-1.8.5-linux64.tar.xz)</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;- Build the repository to generate header files for messages with `catkin build` in any directory of your catkin workspace</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;- Source your workspace with `source ~/your_workspace/devel/setup.bash`</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;- Run the `make_library.sh` script in the root of this repository</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;- If desired install the udev rule file under `resources/99-spmb.rules`, which will install the permanent device node `dev/spmb` to avoid the deviating node identifier ttyACMx with x changing based on the amount of ttyACM devices or reconnections of the same device) </div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;### Interface with ROS</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;- After installing the udev rules (see below) the ROS Interface can be accessed with </div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;```rosrun rosserial_python serial_node.py _port:=/dev/spmb _baud:=57600```</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;- The `rosrun` command is conveniently embedded into the launch file under `launch/run.launch` (see *Execute the ROS Interface* section above)</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;### Install udev-rules</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;- You can find the rules under the folder `resources` with the name `99-spmb.rules`</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;- Easiest way to identify the device node is to unplug all usb devices from your work station except the Arduino UNO. Then before connecting the Arduino you can list the devices with `ls /dev` and then after connecting the Arduino entering the command `ls /dev` should show a new device node entry. (Usually `/dev/ttyACMx` where x is some number relating to the amount of currently registered ttyACM devices)</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;- Assuming that your Arduino identifies with `/dev/ttyACM0` you can list the hardware information with the command</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;```</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;udevadm info -ap /sys/class/tty/ttyACM0</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;```</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;- From there extract the serial attribute with </div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;```</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;udevadm info -ap /sys/class/tty/ttyACM0 | grep &quot;^    ATTRS{serial}==&quot;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;```</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;which should show something similar to </div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;```</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;$ udevadm info -ap /sys/class/tty/ttyACM0 | grep &quot;^    ATTRS{serial}==&quot;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    ATTRS{serial}==&quot;85430353331351E0D120&quot;</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    ATTRS{serial}==&quot;0000:00:14.0&quot;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;```</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;- Open the file `99-spmb.rules` under `resources/` and replace the default entry for serial `ATTRS{serial}==&quot;55736313238351219281&quot;` with your terminal output e.g. `ATTRS{serial}==&quot;85430353331351E0D120&quot;`</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;- Copy the file into the udev folder using super user privileges</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;```</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;sudo cp resources/99-spmb.rules /etc/udev/rules.d/</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;```</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;- Reload and trigger the rules using</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160; ```</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160; udevadm control --reload-rules &amp;&amp; udevadm trigger</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160; ```</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160; </div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;*If `ls /dev` doesn&#39;t show the entry* **dev/spmb** *try rebooting your work station and if the entry still doesn&#39;t show reiterate throught the instructions to make sure you followed them correctly.*</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;***</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;## Contribution</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;Pull requests from forked repositories and opening new issues are very welcome and much appreciated.</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;Contributions are invited to adhere to the [C++ Google Style Guide](https://google.github.io/styleguide/cppguide.html).</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;**Maintainer:** Philipp Rothenhäusler (*phirot a t kth.se | philipp.rothenhaeusler a t gmail.com*)</div></div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
